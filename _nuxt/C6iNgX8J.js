const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BiuaFbcG.js","./D7Ni39_Z.js"])))=>i.map(i=>d[i]);
import{_ as m}from"./D7Ni39_Z.js";import{c as d,a as w,t as u}from"./CtJ3CAqv.js";async function p(t,e){return await $fetch(`/api/content/${e}/database.sql`,{context:{},responseType:"text",headers:{"content-type":"text/plain"},query:{v:d[String(e)],t:void 0}})}async function g(t,e="gzip"){var i;const r=Uint8Array.from(atob(t),a=>a.charCodeAt(0)),n=(i=new Response(new Blob([r])).body)==null?void 0:i.pipeThrough(new DecompressionStream(e));return(await new Response(n).text()).split(`
`)}function f(t,e){const r=h(t),o={...e};for(const n in o)r[n]==="json"&&o[n]&&o[n]!=="undefined"&&(o[n]=JSON.parse(o[n])),r[n]==="boolean"&&o[n]!=="undefined"&&(o[n]=!!o[n]);for(const n in o)o[n]==="NULL"&&(o[n]=void 0);return o}function h(t){const e=t.match(/FROM\s+(\w+)/);if(!e)return{};const r=w[b(e[1])];return(r==null?void 0:r.fields)||{}}function b(t){return t.replace(/^_content_/,"")}let s;function _(t){return{all:async(e,r)=>(await l(t),s.exec({sql:e,bind:r,rowMode:"object",returnValue:"resultRows"}).map(o=>f(e,o))),first:async(e,r)=>(await l(t),f(e,s.exec({sql:e,bind:r,rowMode:"object",returnValue:"resultRows"}).shift())),exec:async e=>{await l(t),await s.exec({sql:e})}}}async function l(t){if(!s){const c=await m(()=>import("./BiuaFbcG.js"),__vite__mapDeps([0,1]),import.meta.url).then(a=>a.default);globalThis.sqlite3ApiConfig={silent:!0,debug:(...a)=>console.debug(...a),warn:(...a)=>{String(a[0]).includes("OPFS sqlite3_vfs")||console.warn(...a)},error:(...a)=>console.error(...a),log:(...a)=>console.log(...a)};const i=await c();s=new i.oo1.DB}if(window.sessionStorage.getItem("previewToken"))return s;let e=null;const r=`checksum_${t}`,o=`collection_${t}`;let n="matched";try{const c=s.exec({sql:`SELECT * FROM ${u.info} where id = '${r}'`,rowMode:"object",returnValue:"resultRows"}).shift();(c==null?void 0:c.version)!==d[String(t)]&&(n="mismatch")}catch{n="missing"}if(n!=="matched"){if(window.localStorage.getItem(`content_${r}`)===d[String(t)]&&(e=window.localStorage.getItem(`content_${o}`)),!e){e=await p(void 0,String(t));try{window.localStorage.setItem(`content_${r}`,d[String(t)]),window.localStorage.setItem(`content_${o}`,e)}catch(i){console.error("Database integrity check failed, rebuilding database",i)}}const c=await g(e);await s.exec({sql:`DROP TABLE IF EXISTS ${u[String(t)]}`}),n==="mismatch"&&await s.exec({sql:`DELETE FROM ${u.info} WHERE id = '${r}'`});for(const i of c)try{await s.exec(i)}catch(a){console.error("Error executing command",a)}}return s}export{_ as loadDatabaseAdapter};
